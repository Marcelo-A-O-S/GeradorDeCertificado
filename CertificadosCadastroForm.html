<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.3/css/dataTables.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/autofill/2.7.0/css/autoFill.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous">
    </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
    integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous">
    </script>
  <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js" crossorigin="anonymous">
  </script>
  <script src="https://cdn.datatables.net/autofill/2.7.0/js/dataTables.autoFill.min.js"
    crossorigin="anonymous"></script>

</head>

<body>
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Atividade em andamento...</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div id="toast-body" class="toast-body">
      </div>
    </div>
  </div>
  <!-- Modal Curso-->
  <div class="modal fade" id="ModalCurso" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Buscar Curso</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="display nowrap" id="tableCurso">
            <thead>
              <tr>
                <th scope="col">IdCursoTurma</th>
                <th scope="col">CursoTurma</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
            onclick="SelecionarCurso()">Selecionar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Aluno-->
  <div class="modal fade" id="ModalAluno" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Buscar Aluno</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="display nowrap" id="tableAluno">
            <thead>
              <tr>
                <th scope="col">Id Aluno</th>
                <th scope="col">Nome</th>
                <th scope="col">Email</th>
                <th scope="col">Cpf</th>
                <th scope="col">Whatsapp</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
            onclick="SelecionarAluno()">Selecionar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Aluno-->
  <div class="modal fade" id="ModalModelo" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Buscar Aluno</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="display nowrap" id="tableModelo">
            <thead>
              <tr>
                <th scope="col">Id</th>
                <th scope="col">Modelo</th>
                <th scope="col">Pasta Armazenada</th>
                <th scope="col">Nome do Curso</th>
                <!-- IdModeloCertificado	IdModelo	IdPasta	Modelo	PastaArmazenada	NomeCurso -->
              </tr>
            </thead>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
            onclick="SelecionarModelo()">Selecionar</button>
        </div>
      </div>
    </div>
  </div>
  <main class="container">
    <form id="CadastroForm">
      <!-- IdCertificado	CursoCompleto	Curso	ChCurso	DtInicio	DtFim	DataExtenso	NomeDoAluno	Cpf	Email	Whatsapp	DtEmissao -->
      <div class="">
        <label for="exampleFormControlInput1" class="form-label">Id</label>
        <input type="text" class="form-control" id="IdCertificado" disabled>
      </div>
      <div class="" style="display: none;">
        <label for="exampleFormControlInput1" class="form-label">IdCurso</label>
        <input type="text" class="form-control" id="IdCursoTurma" disabled>
      </div>
      <div class="d-flex align-items-center">
        <div class="col mb-3">
          <label for="exampleFormControlInput1" class="form-label">Curso Completo</label>
          <input type="text" class="form-control" id="CursoTurma" required placeholder="Selecione o curso...">
        </div>
        <button type="button" class="btn text-center" data-bs-toggle="modal" data-bs-target="#ModalCurso">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search"
            viewBox="0 0 16 16">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
          </svg>
        </button>
      </div>
      <div class="col mb-3">
        <label for="exampleFormControlInput1" class="form-label">Curso</label>
        <input type="text" class="form-control" id="Curso" placeholder="" required disabled>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Data de Inicio</label>
          <input type="date" class="form-control" id="DtInicio" placeholder="" required disabled>
        </div>
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Data de finalização</label>
          <input type="date" class="form-control" id="DtFim" placeholder="" required disabled>
        </div>
      </div>
      <div class="" style="display: none;">
        <label for="exampleFormControlInput1" class="form-label">IdModeloCertificado</label>
        <input type="text" class="form-control" id="IdModeloCertificado" disabled>
      </div>
      <div class="d-flex align-items-center">
        <div class="col mb-3">
          <label for="exampleFormControlInput1" class="form-label">Modelo de Certificado</label>
          <input type="text" class="form-control" id="Modelo" disabled required
            placeholder="Selecione o modelo do certificado...">
        </div>
      </div>
      <div class="mb-3">
        <label for="exampleFormControlInput1" class="form-label">Pasta Armazenada</label>
        <input type="text" class="form-control" id="PastaArmazenada" required placeholder="" disabled>
      </div>
      <div class="" style="display: none;">
        <label for="exampleFormControlInput1" class="form-label">IdAluno</label>
        <input type="text" class="form-control" id="IdAluno" disabled>
      </div>
      <div class="d-flex align-items-center">
        <div class="col mb-3">
          <label for="exampleFormControlInput1" class="form-label">Aluno</label>
          <input type="text" class="form-control" id="Nome" required placeholder="Selecione o aluno...">
        </div>
        <button type="button" class="btn text-center" data-bs-toggle="modal" data-bs-target="#ModalAluno">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search"
            viewBox="0 0 16 16">
            <path
              d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
          </svg>
        </button>
      </div>
      <div class="mb-3">
        <label for="exampleFormControlInput1" class="form-label">Email</label>
        <input type="text" class="form-control" id="Email" required placeholder="" disabled>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Cpf</label>
          <input type="text" class="form-control" id="Cpf" placeholder="" required disabled>
        </div>
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Whatsapp</label>
          <input type="text" class="form-control" id="Whatsapp" placeholder="" required disabled>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>

    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous">
    </script>
  <script>
    var toastBody = document.getElementById('toast-body');
    const toastLiveExample = document.getElementById('liveToast');
    const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
    let dataTableCurso = new DataTable('#tableCurso', {
      scrollCollapse: true,
      scroller: true,
      scrollY: 200,
      scrollX: true
    });
    let dataTableAluno = new DataTable('#tableAluno', {
      scrollCollapse: true,
      scroller: true,
      scrollY: 200,
      scrollX: true
    });
    let dataTableModelo = new DataTable('#tableModelo', {
      scrollCollapse: true,
      scroller: true,
      scrollY: 200,
      scrollX: true
    });
    function formatDateToInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    const myModalCurso = document.getElementById('ModalCurso');
    const myModalAluno = document.getElementById('ModalAluno')
    const myModalModelo = document.getElementById('ModalModelo')
    var inputIdCurso = document.getElementById("IdCursoTurma");
    var inputIdAluno = document.getElementById("IdAluno")
    var inputIdModelo = document.getElementById("IdModeloCertificado")
    document.getElementById("CadastroForm").addEventListener("submit", (e) => {
      e.preventDefault();
      toastBootstrap.show()
      toastBody.textContent = `Salvando certificado...`
      SalvarCertificado();
    })
    //Functions
    function SalvarCertificado() {
      var certificado = {}
      var inputs = document.querySelectorAll(".form-control");
      inputs.forEach((item) => {
        certificado[item.id] = item.value
      })
      if (certificado.IdCertificado !== "") {
        certificado = JSON.stringify(certificado);
        google.script.run.withSuccessHandler(function (retorno) {
          toastBody.textContent = retorno;
          google.script.run.withSuccessHandler().FormListarCertificados()
        }).AtualizarCertificado(certificado)
      } else {
        certificado = JSON.stringify(certificado);
        google.script.run.withSuccessHandler(function (retorno) {
          toastBody.textContent = retorno;
          google.script.run.withSuccessHandler().FormListarCertificados()
        }).SalvarCertificados(certificado)
      }
    }
    function SelecionarCurso() {
      toastBootstrap.show()
      toastBody.textContent = `Buscando curso...`
      var idCurso = inputIdCurso.value;
      if (idCurso) {
        google.script.run.withSuccessHandler(function (cursoTurma) {
          cursoTurma = JSON.parse(cursoTurma);
          for (const [key, value] of Object.entries(cursoTurma)) {
            let val = value;
            if (key == "DtInicio" || key == "DtFim") {
              val = formatDateToInput(value);
            }
            document.getElementById(key).value = val;
          }
          toastBody.textContent = `Buscando modelo...`
          google.script.run.withSuccessHandler(function (modelo) {
            modelo = JSON.parse(modelo);
            for (const [key, value] of Object.entries(modelo)) {
              if (key === "Modelo" || key === "PastaArmazenada" || key == "IdModeloCertificado") {
                document.getElementById(key).value = value;
              }
            }
            toastBootstrap.hide();
          }).BuscarModeloCertificadoPorCurso(cursoTurma.IdCursoTurma);
        }).BuscarCursoTurma(idCurso)
      }
    }
    function SelecionarAluno() {
      toastBootstrap.show();
      toastBody.textContent = `Buscando aluno...`;
      var idAluno = inputIdAluno.value
      if (idAluno) {
        google.script.run.withSuccessHandler(function (aluno) {
          aluno = JSON.parse(aluno);
          for (const [key, value] of Object.entries(aluno)) {
            if (key !== "Genero") {
              document.getElementById(key).value = value;
            }
          }
          toastBootstrap.hide();
        }).BuscarAluno(idAluno)
      }
    }
    //Events
    document.addEventListener("DOMContentLoaded", () => {
      if (document.getElementById("CertificadoEdit") != null) {
        var certificadoEdit = document.getElementById("CertificadoEdit").innerText;
        certificadoEdit = parseInt(certificadoEdit);
        google.script.run.withSuccessHandler(function (certificado) {
          certificado = JSON.parse(certificado)

          for (const [key, value] of Object.entries(certificado)) {
            if (key !== "Codigo" && key !== "DataEnvio" && key !== "Envio" && key !== "Qrcode" && key !== "Status" && key !== "ChCurso" && key !== "DtEmissao" && key !== "Certificado") {
              let val = value;
              if (key == "DtInicio" || key == "DtFim") {
                val = formatDateToInput(value);
              }
              document.getElementById(key).value = val;
            }

          }
        }).BuscarCertificado(certificadoEdit)
      }
    })
    myModalModelo.addEventListener('shown.bs.modal', () => {
      google.script.run.withSuccessHandler(function (modelos) {
        modelos = JSON.parse(modelos);
        modelos = modelos.map(modelo => [
          modelo.IdModeloCertificado,
          modelo.Modelo,
          modelo.PastaArmazenada,
          modelo.NomeCurso,
        ])
        dataTableModelo.clear();
        dataTableModelo.rows.add(modelos);
        dataTableModelo.draw();
      }).BuscarModelosCertificado()
    })
    myModalAluno.addEventListener('shown.bs.modal', () => {
      toastBootstrap.show();
      toastBody.textContent = `Buscando alunos...`
      google.script.run.withSuccessHandler(function (alunos) {
        alunos = JSON.parse(alunos);
        alunos = alunos.map(aluno => [
          aluno.IdAluno,
          aluno.Nome,
          aluno.Email,
          aluno.Cpf,
          aluno.Whatsapp
        ]);
        dataTableAluno.clear();
        dataTableAluno.rows.add(alunos);
        dataTableAluno.draw();
        toastBootstrap.hide();
      }).BuscarAlunos()
    })
    myModalCurso.addEventListener('shown.bs.modal', () => {
      toastBootstrap.show();
      toastBody.textContent = `Buscando cursos...`
      google.script.run.withSuccessHandler(function (cursosTurma) {
        cursosTurma = JSON.parse(cursosTurma);
        cursosTurma = cursosTurma.map(cursoTurma => {
          return [
            cursoTurma.IdCursoTurma,
            cursoTurma.CursoTurma
          ]
        });
        dataTableCurso.clear();
        dataTableCurso.rows.add(cursosTurma);
        dataTableCurso.draw();
        toastBootstrap.hide();
      }).BuscarCursosTurma();
    })
    $('#tableCurso tbody').on('click', 'tr', function () {
      if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
      } else {
        dataTableCurso.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
      }

      let row = dataTableCurso.row(this).data();
      inputIdCurso.value = row[0];
    });
    $('#tableAluno tbody').on('click', 'tr', function () {
      if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
      } else {
        dataTableAluno.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
      }
      let row = dataTableAluno.row(this).data();
      inputIdAluno.value = row[0];
    });
    $('#tableModelo tbody').on('click', 'tr', function () {
      if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
      } else {
        dataTableModelo.$('tr.selected').removeClass('selected');
        $(this).addClass('selected');
      }
      let row = dataTableModelo.row(this).data();
      inputIdModelo.value = row[0];
    });
  </script>
</body>

</html>