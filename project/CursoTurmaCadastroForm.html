<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous">
    </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
    integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous">
    </script>

</head>

<body>
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Atividade em andamento...</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div id="toast-body" class="toast-body">
      </div>
    </div>
  </div>
  <main class="container">
    <form id="CadastroForm">
      <!-- CursoTurma	Curso	DtInicio	DtFim	DataExtenso	ChCurso -->
      <div class="mb-3">
        <label for="exampleFormControlInput1" class="form-label">Id</label>
        <input type="text" class="form-control" id="IdCursoTurma" disabled>
      </div>
      <div class="mb-3">
        <label for="exampleFormControlInput1" class="form-label">Curso e a Turma</label>
        <textarea class="form-control" id="CursoTurma" disabled rows="3"></textarea>
      </div>
      <div class="mb-3">
        <label for="exampleFormControlInput1" class="form-label">Curso</label>
        <input type="text" class="form-control" id="Curso" placeholder="Informe o curso..." required>
      </div>
      <div class="row mb-3">
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Data de Inicio</label>
          <input type="date" class="form-control" id="DtInicio" required>
        </div>
        <div class="col">
          <label for="exampleFormControlInput1" class="form-label">Data de finalização</label>
          <input type="date" class="form-control" id="DtFim" required>
        </div>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>

    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous">
    </script>
  <script>
    var toastBody = document.getElementById('toast-body');
    const toastLiveExample = document.getElementById('liveToast');
    const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
    var inputCurso = document.getElementById("Curso");
    var inputCursoTurma = document.getElementById("CursoTurma");
    var inputDtInicio = document.getElementById("DtInicio");
    var inputDtFim = document.getElementById("DtFim");
    document.getElementById("CadastroForm").addEventListener('submit', (e) => {
      e.preventDefault();
      toastBootstrap.show()
      toastBody.textContent = `Salvando curso...`
      SalvarCursoTurma();
    })
    function parseDateLocal(dateString) {
      const [year, month, day] = dateString.split("-");
      return new Date(year, month - 1, day);
    }
    function formatDateToInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    function atualizarTexto() {
      const curso = inputCurso.value || "Curso";
      console.log(inputDtInicio.value)
      const dtInicio = inputDtInicio.value ? parseDateLocal(inputDtInicio.value).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR');
      const dtFim = inputDtFim.value ? parseDateLocal(inputDtFim.value).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR');
      inputCursoTurma.value = `${curso} - ${dtInicio} à ${dtFim}`;
    }

    inputCurso.addEventListener("input", atualizarTexto);
    inputDtInicio.addEventListener("input", atualizarTexto);
    inputDtFim.addEventListener("input", atualizarTexto);
    function SalvarCursoTurma() {
      var cursoTurma = {};
      var inputs = document.querySelectorAll(".form-control");
      inputs.forEach((item) => {
        cursoTurma[item.id] = item.value
      });
      cursoTurma = JSON.stringify(cursoTurma)
      google.script.run.withSuccessHandler(function (retorno) {
        toastBody.textContent = retorno;
        google.script.run.withSuccessHandler().FormListarCursoTurma();
      }).SalvarCursoTurma(cursoTurma)
    }

    document.addEventListener("DOMContentLoaded", () => {
      inputCursoTurma.value = `Curso - ${new Date().toLocaleDateString('pt-BR')} à ${new Date().toLocaleDateString('pt-BR')}`
      if (document.getElementById("CursoTurmaEdit") != null) {
        var cursoTurmaEdit = document.getElementById("CursoTurmaEdit").innerText;
        cursoTurmaEdit = parseInt(cursoTurmaEdit);
        google.script.run.withSuccessHandler(function (cursoTurma) {
          cursoTurma = JSON.parse(cursoTurma)
          cursoTurma.DtInicio = formatDateToInput(cursoTurma.DtInicio);
          cursoTurma.DtFim = formatDateToInput(cursoTurma.DtFim);
          for (const [key, value] of Object.entries(cursoTurma)) {
            document.getElementById(key).value = value;
          }
        }).BuscarCursoTurma(cursoTurmaEdit)
      }
    })

  </script>
</body>

</html>